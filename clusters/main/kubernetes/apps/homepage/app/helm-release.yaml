apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: homepage
  namespace: homepage
spec:
  interval: 15m
  chart:
    spec:
      chart: homepage
      version: 11.18.1 
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # persistence:
    #   config:
    #     enabled: true
    #     type: configmap           # tell TrueCharts to use a ConfigMap
    #     objectName: homepage-values  
    #     expandObjectName: false       # <- use exact name, donâ€™t prefix
    #     optional: true
    #     mountPath: /app/config
    #     readOnly: true
    ingress:
        main:
          enabled: true
          ingressClassName: internal
          annotations:
          integrations:
            nginx:
              enabled: true
              auth:
                type: "authelia"
                internalHost: "authelia.authelia.svc.cluster.local:9091"
                externalHost: "auth.${DOMAIN_0}"
            traefik:
              enabled: false
            certManager:
              enabled: true
              certificateIssuer: domain-0-le-prod
          hosts:
            - host: homepage.${DOMAIN_0}
              paths:
                - path: /
                  pathType: Prefix
    configmap:
      config:

        enabled: true
        data:
          custom.js: ""
          custom.css: ""
          kubernetes.yaml: |
            mode: cluster
            ingress: true
          settings.yaml: |
            ---
            # For configuration options and examples, please see:
            # https://gethomepage.dev/latest/configs/settings
            instanceName: internal
            useEqualHeights: true

            layout:
              External Users:
                header: false
                tab: All Users
                style: row
                columns: 3
                Entertainment:
                  style: row
                  columns: 2
                Utility:
                  style: row
                Auth Tools:
                  style: row
                  columns: 2
              Internal Users:
                header: false
                style: row
                columns: 3
                tab: 2651 only
                Entertainment:
                  style: row
                  columns: 2
                Utility:
                  style: row
                Auth Tools:
                  style: row
                  # columns: 1
              Max:
                header: false
                tab: Max Only
                style: row
                columns: 3
                Entertainment:
                  style: row
                  columns: 2
                Utility:
                  style: row
                  columns: 2
                Auth Tools:
                  style: row

              Server Management:
                style: row
                tab: Max Only
                columns: 2
              WIP:
                icon: mdi-sign-caution
                style: row
                tab: Max Only
                columns: 3

              Arr Stack:
                tab: Max Only
                icon: mdi-pirate
                style: row
                columns: 4
                initiallyCollapsed: true


          services.yaml: |
            ---
            - Internal Users:
              - Entertainment:
                - Audiobookshelf:
                    href: https://abs.${DOMAIN_0}
                    description: Listen to audiobooks
                    icon: audiobookshelf.png 
                - Jellyfin:
                    href: https://jellyfin.${DOMAIN_0}
                    description: Watch TV shows and movies
                    icon: jellyfin.png
                - Kavita:
                    href: https://kav.${DOMAIN_0}
                    description: Read E-books and Graphic Novels
                    icon: kavita.png
                - Jellyseerr:
                    href: https://jellyseerr.${DOMAIN_0}
                    description: Request TV shows and movies
                    icon: jellyseerr.png
              - Utility:
                - Home Assistant:
                    href: ${HOMEASSISTANT_URL}
                    description: Home Automation
                    icon: home-assistant.png
                - Mealie:
                    href: https://mealie.${DOMAIN_0}
                    description: Find Local Recipes here
                    icon: mealie.png
                - Immich:
                    href: https://immich.${DOMAIN_0}
                    description: Local photo and video backup
                    icon: immich.png
                
              - Auth Tools:
                - Authelia:
                    href: https://auth.${DOMAIN_0}
                    description: Manage your Login creds
                    icon: authelia.png 

            - External Users:
              - Entertainment:
                - Audiobookshelf:
                    href: https://abs.${DOMAIN_0}
                    description: Listen to audiobooks
                    icon: audiobookshelf.png 
                - Kavita:
                    href: https://kav.${DOMAIN_0}
                    description: Read E-books and Graphic Novels
                    icon: kavita.png
              - Utility:
                - Mealie:
                    href: https://mealie.${DOMAIN_0}
                    description: Find Local Recipes here
                    icon: mealie.png
              - Auth Tools:
                - Authelia:
                    href: https://auth.${DOMAIN_0}
                    description: Manage your Login creds
                    icon: authelia.png 

            - Max:
              - Entertainment:
                - Audiobookshelf:
                    href: https://abs.${DOMAIN_0}
                    description: Listen to audiobooks
                    icon: audiobookshelf.png 
                - Jellyfin:
                    href: https://jellyfin.${DOMAIN_0}
                    description: Watch TV shows and movies
                    icon: jellyfin.png
                - Kavita:
                    href: https://kav.${DOMAIN_0}
                    description: Read E-books and Graphic Novels
                    icon: kavita.png
                - Jellyseerr:
                    href: https://jellyseerr.${DOMAIN_0}
                    description: Request TV shows and movies
                    icon: jellyseerr.png
              - Utility:
                - Home Assistant:
                    href: ${HOMEASSISTANT_URL}
                    description: Home Automation
                    icon: home-assistant.png
                - Mealie:
                    href: https://mealie.${DOMAIN_0}
                    description: Find Local Recipes here
                    icon: mealie.png
                - Immich:
                    href: https://immich.${DOMAIN_0}
                    description: Local photo and video backup
                    icon: immich.png
                - Actual:
                    href: https://actual.${DOMAIN_0}
                    description: Local Budgeting Software
                    icon: actual-budget.png
              - Auth Tools:
                - Authelia:
                    href: https://auth.${DOMAIN_0}
                    description: Manage your Login creds
                    icon: authelia.png 
                - Lldap:
                    href: https://lldap.${DOMAIN_0}
                    description: Permissions Manager
                    icon: lldap.png
            - Server Management:
                - Uptime Kuma:
                    href: https://uptime.${DOMAIN_0}
                    description: Endpoint monitoring
                    icon: uptime-kuma.png 
                - Kubernetes Dashboard:
                    href: https://kube.${DOMAIN_0}
                    description: Cluster Dashboard
                    icon: kubernetes.png
                - TrueNAS:
                    href: ${TRUENAS_URL}
                    description: Truenas instance
                    icon: truenas-scale.png
                    widget:
                        type: truenas
                        url: ${TRUENAS_URL}
                        key: ${TRUENAS_KEY}
                - Homepage Editor:
                    href: https://editor.homepage.${DOMAIN_0}
                    description: Homepage config editor
                    icon: homepage.png
            - WIP:
              - Organizr:
                    href: https://organizr.${DOMAIN_0}
                    description: Possible dashboard replacement
                    icon: organizr.png  
              - Invidious:
                    href: https://yt.${DOMAIN_0}
                    description: Possible local YouTube replacement
                    icon: invidious.png  
          bookmarks.yaml: |
            ---
            - External:
                - Myanonamouse:
                    - href: https://www.myanonamouse.net
                      abbr: MA
                      description: Torrent server for E-books and Audiobooks
                - Homepage Docs:
                    - href: https://gethomepage.dev
                      abbr: HD
                      description: Homepage docs for config reference

            
    workload:
      main:
        podSpec:
          # automountServiceAccountToken: true
          containers:
            main:
              env:
                # Set this to your host (example: home.mydomain.com)
                HOMEPAGE_ALLOWED_HOSTS: "homepage.${DOMAIN_0}"
    addons:
      codeserver:
        enabled: true
        # service:
        #   type: "ClusterIP"
        #   ports:
        #     codeserver:
        #       port: 36107
        ingress:
          enabled: true
          ingressClassName: "internal" 
          hosts:
            - host: editor.homepage.${DOMAIN_0}
              paths:
                - path: /
                  # Ignored if not kubeVersion >= 1.14-0
                  pathType: Prefix
          integrations:
            nginx:
              enabled: true
              auth:
                type: "authelia"
                internalHost: "authelia.authelia.svc.cluster.local:9091"
                externalHost: "auth.${DOMAIN_0}"
            traefik:
              enabled: false
            certManager:
              enabled: true
              certificateIssuer: domain-0-le-prod