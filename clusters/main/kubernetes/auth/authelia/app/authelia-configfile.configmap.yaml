apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-configfile
  namespace: authelia
data:
  configuration.yaml: |
    server:
        buffers:
          read: 16384
          write: 16384
    theme: auto
    totp:
      issuer: ${DOMAIN_0}
    authentication_backend:
      ldap:
        address: ldap://lldap-ldap.lldap.svc.cluster.local:3890
        tls:
          server_name: lldap.${DOMAIN_0}
        base_dn: "dc=homelab,dc=home"
        attributes:
          username: uid
        additional_users_dn: ou=people
        users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))
        additional_groups_dn: ou=groups
        groups_filter: (member={dn})
        user: uid=admin,ou=people,dc=homelab,dc=home
        password: ${LLDAP_PASSWORD}
    access_control:
      rules:
      - domain:
          - ${DOMAIN_0}
          - '*.${DOMAIN_0}'
        policy: two_factor
        subject:
          - 'group:admin'
    session:
      cookies:
        - domain: '${DOMAIN_0}'
          authelia_url: 'https://auth.${DOMAIN_0}'
          default_redirection_url: 'https://www.${DOMAIN_0}'
    regulation:
      find_time: 10m
      ban_time: 12h
    notifier:
      disable_startup_check: false
      filesystem:
        filename: '/config/notification.txt'
    identity_providers:
      oidc:
        cors:
          endpoints: ["authorization", "token", "revocation", "introspection"]
          allowed_origins_from_client_redirect_uris: true
        hmac_secret: "${AUTHELIA_HMAC_SECRET}"
        jwks:
          - algorithm: "RS256"
            use: "sig"
            key: |
                {{ secret "/config/jwks/rsa_private_key.pem" | mindent 10 "|" | msquote }}
        clients:
          - client_id: ${MEALIE_OIDC_CLIENT_ID}
            client_name: "Mealie"
            client_secret: "${MEALIE_HASHED_OIDC_CLIENT_SECRET}"
            public: false
            authorization_policy: "two_factor"
            redirect_uris:
              - "https://mealie.${DOMAIN_0}/auth/oidc.callback"
            scopes:
            - 'openid'
            - 'email'
            - 'profile'
            - 'groups'
            userinfo_signed_response_alg: "none"
            token_endpoint_auth_method: "client_secret_post"